"use client";

import { useState, useEffect } from 'react';
import { getBlogPosts, getTestimonials } from '@/lib/api';
import type { BlogPost, Testimonial } from '@/types';
import BlogCard from '@/components/BlogCard';
import TestimonialCard from '@/components/TestimonialCard';
import BlogPostModal from '@/components/BlogPostModal'; // We will create this new component

export default function CommunityPage() {
  const [posts, setPosts] = useState<BlogPost[]>([]);
  const [testimonials, setTestimonials] = useState<Testimonial[]>([]);
  
  // This new state will track which blog post is open in the modal
  const [activePostIndex, setActivePostIndex] = useState<number | null>(null);

  useEffect(() => {
    async function fetchData() {
      const [blogData, testimonialData] = await Promise.all([
        getBlogPosts(),
        getTestimonials()
      ]);
      setPosts(blogData);
      setTestimonials(testimonialData);
    }
    fetchData();
  }, []);

  // Function to open the modal with a specific post
  const openModal = (index: number) => {
    setActivePostIndex(index);
    // Prevents the page behind the modal from scrolling
    document.body.style.overflow = 'hidden';
  };

  // Function to close the modal
  const closeModal = () => {
    setActivePostIndex(null);
    // Re-enables page scrolling
    document.body.style.overflow = '';
  };
  
  // Function to handle next/previous navigation within the modal
  const navigateModal = (newIndex: number) => {
    if (newIndex >= 0 && newIndex < posts.length) {
      setActivePostIndex(newIndex);
    }
  };

  return (
    <div className="bg-gradient-to-br from-gray-50 to-teal-50 min-h-screen">
      {/* Your existing Hero Section - No changes needed */}
      <section className="relative bg-gradient-to-br from-teal-800 via-teal-600 to-amber-500 text-white py-24 text-center overflow-hidden">
        <div className="absolute top-0 left-0 w-full h-full">
          <div className="absolute top-20 left-10 w-32 h-32 bg-white/10 rounded-full animate-float"></div>
          <div className="absolute top-40 right-20 w-24 h-24 bg-amber-400/20 rounded-full animate-float" style={{animationDelay: '1s'}}></div>
          <div className="absolute bottom-20 left-20 w-16 h-16 bg-teal-400/20 rounded-full animate-float" style={{animationDelay: '2s'}}></div>
        </div>
        <div className="relative z-10 container mx-auto px-6">
          <div className="animate-fade-in-up">
            <h1 className="text-5xl md:text-6xl font-bold tracking-tight mb-6">Traveler Stories</h1>
            <p className="text-xl text-teal-100 max-w-3xl mx-auto leading-relaxed">
              Dive into authentic experiences, travel tips, and inspiring stories from fellow adventurers who have explored the world with us.
            </p>
          </div>
        </div>
      </section>

      {/* Blog Posts Section - Updated to trigger the modal */}
      <section className="py-20">
        <div className="container mx-auto px-6">
          <div className="text-center mb-16 animate-fade-in-up">
            <h2 className="text-4xl font-bold text-gray-800 mb-6">From Our Blog</h2>
            <p className="text-lg text-gray-600 max-w-3xl mx-auto leading-relaxed">
              Discover travel insights, destination guides, and personal stories from our community of adventurers.
            </p>
          </div>
          
          {posts.length > 0 ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
              {posts.map((post, index) => (
                <div 
                  key={post.id} 
                  className="animate-fade-in-up hover-lift cursor-pointer"
                  style={{animationDelay: `${index * 0.1}s`}}
                  // This onClick handler is the magic part
                  onClick={() => openModal(index)} 
                >
                  <BlogCard post={post} />
                </div>
              ))}
            </div>
          ) : (
            // Your existing "Coming Soon" placeholder
            <div className="text-center py-20 animate-fade-in-up">
                {/* ... your placeholder SVG and text ... */}
            </div>
          )}
        </div>
      </section>

      {/* Your existing Testimonials Section - No changes needed */}
      {testimonials.length > 0 && (
        <section className="relative bg-gradient-to-br from-teal-50 to-amber-50 py-24 overflow-hidden">
           {/* ... your testimonials grid ... */}
        </section>
      )}

      {/* This conditionally renders the Modal when a post is active */}
      {activePostIndex !== null && (
        <BlogPostModal
          posts={posts}
          initialPostIndex={activePostIndex}
          onClose={closeModal}
          onNavigate={navigateModal}
        />
      )}
    </div>
  );
}

